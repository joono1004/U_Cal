<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>실적 계산기</title>

<style>
  /* ✅ 전체 가로/여백 컴팩트 */
  body{font-family:Arial; padding:14px;}
  table{
    border-collapse:collapse;
    width:100%;
    table-layout:fixed;
  }
  th,td{
    border:1px solid #ccc;
    padding:6px 6px;
    text-align:center;
    vertical-align:middle;
    font-size:13px;
  }
  th{
    background:#f2f2f2;
    white-space:nowrap;
  }

  /* ✅ 칼럼 폭(요청: BC/좌점/우점 = '좌측 실적이월'과 동일한 폭으로 맞춤) */
  col.bc    { width:105px; }     /* ✅ carry(좌측 실적이월)와 동일 */
  col.score { width:105px; }     /* ✅ carry(좌측 실적이월)와 동일 */
  col.carry { width:105px; }
  col.sum   { width:86px; }
  col.ack   { width:86px; }
  col.bonus { width:105px; }

  /* 숫자 입력 스피너 제거 */
  input[type=number]::-webkit-inner-spin-button,
  input[type=number]::-webkit-outer-spin-button{ -webkit-appearance:none; margin:0; }
  input[type=number]{ -moz-appearance:textfield; appearance:textfield; }

  /* ✅ 입력/셀렉트 폭(칼럼 폭에 맞춰 축소) */
  input{width:68px; text-align:center;}
  select{width:86px;}

  .blue{color:blue; font-weight:bold;}
  .mini{font-size:11px; color:#666; margin-top:3px;}
  .scoreCell{display:flex; flex-direction:column; align-items:center; gap:3px;}
  .mainScore{font-size:inherit; font-weight:normal;}

  .totalRow td{background:#fafafa; font-weight:bold;}
  .totalLabel{text-align:right; padding-right:10px;}

  /* ✅ 상단(사용자ID 줄) 정렬 */
  .headRow{
    display:flex;
    align-items:center;
    gap:8px;
    margin-bottom:10px;
    font-size:13px;
  }
  .headRow .spacer{ flex:1; }
  .resetBtn{
    padding:6px 10px;
    border:1px solid #ccc;
    background:#fff;
    cursor:pointer;
    border-radius:6px;
    font-size:13px;
    white-space:nowrap;
  }
  .resetBtn:hover{ background:#f7f7f7; }

  /* ✅ +추가 BC 버튼: 컴팩트 */
  #addCenterBtn{
    padding:4px 8px;
    font-size:12px;
    border-radius:8px;
    line-height:1.1;
  }

  /* ✅ 비즈니스센터 셀: 폭이 줄어도 안전(줄임표) */
  .bcCell{
    position:relative;
    display:flex;
    justify-content:center;
    align-items:flex-start;
    padding:2px 12px 2px 12px;
    border-radius:6px;
    transition:background .12s ease;
  }
  .bcCell:hover{ background:#f3f6ff; }

  .bcText{
    display:flex;
    flex-direction:column;
    align-items:center;
    width:100%;
    max-width:92px;             /* ✅ bc col(105) 안에서 안전 */
  }

  .bcId{
    display:block;
    width:100%;
    font-size:11px;             /* ✅ 더 축소 */
    font-weight:800;
    letter-spacing:-0.2px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    line-height:1.1;
  }

  .bcMini{
    font-size:10px;
    color:#666;
    margin-top:2px;
    white-space:nowrap;
    line-height:1.1;
  }

  /* ✅ X 버튼 */
  .delBtn{
    position:absolute;
    right:4px;
    top:3px;

    background:transparent;
    border:none;
    cursor:pointer;

    width:18px;
    height:18px;
    border-radius:50%;

    display:flex;
    align-items:center;
    justify-content:center;

    font-size:12px;
    line-height:1;
    padding:0;

    color:#800;
    font-weight:800;

    opacity:0;
    pointer-events:none;
    transition:opacity .12s ease, background-color .12s ease, box-shadow .12s ease;
  }
  .bcCell:hover .delBtn,
  .delBtn:focus-visible{
    opacity:1;
    pointer-events:auto;
  }
  .delBtn:hover{
    background:#ffeaea;
    box-shadow:0 0 0 1px #f2b6b6 inset;
  }

  /* 비활성 입력 시각화 */
  input:disabled{
    background:#f5f5f5;
    color:#aaa;
  }

  /* 하이라이트 */
  .hl{
    box-shadow: inset 0 0 0 2px #ffb000;
    background: #fff7d6;
    border-color:#ffb000 !important;
  }

  /* ✅ 도식 영역 */
  .diagramWrap{ margin-top:14px; }
  .diagramTitle{ font-weight:700; margin:10px 0 6px; }

  /* ===========================
     ✅ 도식: 조직도(Org Chart) UI
     =========================== */
  .diagramUI{
    border:1px solid #e5e7eb;
    background: linear-gradient(180deg, #ffffff, #fbfbff);
    padding:14px;
    border-radius:12px;
    overflow:auto;
  }
  .orgWrap{ min-width: 980px; }
  .orgTop{
    display:flex;
    justify-content:center;
    margin-bottom:14px;
  }
  .orgRow{
    display:flex;
    gap:26px;
    align-items:flex-start;
    justify-content:space-between;
  }
  .orgCol{
    flex:1;
    min-width: 420px;
    padding:12px;
    border-radius:14px;
    border:1px solid #eef0f6;
    background:#ffffff;
    box-shadow: 0 8px 22px rgba(0,0,0,.04);
  }
  .orgColTitle{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:10px;
    font-weight:800;
    color:#111827;
  }
  .orgBadge{
    font-size:11px;
    padding:2px 10px;
    border-radius:999px;
    border:1px solid #e6e6e6;
    background:#f8fafc;
    color:#374151;
  }

  .orgNode{
    display:inline-flex;
    flex-direction:column;
    align-items:center;
    gap:4px;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid #e6e6e6;
    background:#fff;
    box-shadow: 0 10px 26px rgba(0,0,0,.07);
    min-width: 230px;
    position:relative;

    --shiftL: 0px;
    --shiftR: 0px;
  }
  .orgNode .id{ font-weight:900; letter-spacing:.2px; }
  .orgNode .meta{ font-size:12px; color:#6b7280; }

  .sidePill{
    font-size:11px;
    font-weight:900;
    padding:2px 8px;
    border-radius:999px;
    border:1px solid #e6e6e6;
    background:#f8fafc;
    color:#111827;
    margin-top:2px;
  }
  .sidePill.L{ background:#eef2ff; border-color:#dbeafe; color:#1d4ed8; }
  .sidePill.R{ background:#fff7ed; border-color:#fed7aa; color:#c2410c; }

  .nodeTotals{
    display:flex;
    gap:10px;
    margin-top:6px;
    justify-content:center;
  }
  .scoreBadge{
    font-size:12px;
    font-weight:800;
    padding:4px 10px;
    border-radius:10px;
    border:1px solid #e6e6e6;
    background:#f8fafc;
    color:#111827;
    white-space:nowrap;
  }
  .scoreBadge .k{
    font-size:11px;
    font-weight:900;
    margin-right:6px;
    opacity:.75;
  }
  .scoreBadge.L{ background:#eef2ff; border-color:#dbeafe; color:#1d4ed8; }
  .scoreBadge.R{ background:#fff7ed; border-color:#fed7aa; color:#c2410c; }

  .scoreBadge.cap{
    border:2px solid #1d4ed8;
    box-shadow: 0 0 0 1px #1d4ed8 inset;
  }

  .nodeLine{
    display:grid;
    grid-template-columns: auto auto;
    justify-content:center;
    column-gap:18px;
    width:100%;
    margin-top:6px;
  }
  .nodeLine.main,
  .nodeLine.carry{
    font-size:12px;
    font-weight:600;
    letter-spacing:.1px;
    color:#374151;
  }

  .val{
    display:block;
    text-align:right;
    min-width:6ch;
    font-variant-numeric: tabular-nums;
    font-feature-settings: "tnum";
  }

  .carryCell{
    position:relative;
    width:6ch;
    justify-self:end;
  }
  .carryLabel{
    position:absolute;
    left:-52px;
    top:0;
    opacity:.75;
    font-weight:600;
    color:#4b5563;
    white-space:nowrap;
    pointer-events:none;
  }
  .carryVal{
    display:block;
    width:100%;
    text-align:right;
    font-variant-numeric: tabular-nums;
    font-feature-settings: "tnum";
  }

  .orgNode .nodeLine.main > :nth-child(1){ transform: translateX(var(--shiftL)); }
  .orgNode .nodeLine.main > :nth-child(2){ transform: translateX(var(--shiftR)); }
  .orgNode .carryVal{ transform: translateX(var(--shiftL)); }
  .orgNode .nodeLine.carry > :nth-child(2){ transform: translateX(var(--shiftR)); }

  .orgTree{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:12px;
  }
  .orgTree.hasChildren > .orgNode::after{
    content:"";
    position:absolute;
    left:50%;
    top:100%;
    transform:translateX(-50%);
    width:2px;
    height:14px;
    background:#e5e7eb;
    border-radius:999px;
  }

  .orgChildrenLR{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:18px;
    align-items:start;
    justify-content:center;
    width:100%;
    padding-top:18px;
    position:relative;
  }
  .orgChildrenLR::before{
    content:"";
    position:absolute;
    left:50%;
    top:8px;
    transform:translateX(-50%);
    width:10px;
    height:10px;
    border-radius:50%;
    background:#e5e7eb;
  }

  .orgLane{
    border:1px dashed #e5e7eb;
    border-radius:14px;
    padding:12px 10px 10px;
    background:#fafafa;
    position:relative;
  }
  .orgLaneTitle{
    display:flex;
    justify-content:center;
    margin-bottom:10px;
  }
  .orgLaneTitle .lanePill{
    font-size:11px;
    font-weight:900;
    padding:3px 10px;
    border-radius:999px;
    border:1px solid #e6e6e6;
    background:#fff;
    color:#111827;
  }
  .orgLaneTitle .lanePill.L{ background:#eef2ff; border-color:#dbeafe; color:#1d4ed8; }
  .orgLaneTitle .lanePill.R{ background:#fff7ed; border-color:#fed7aa; color:#c2410c; }

  .orgLane.L::before,
  .orgLane.R::before{
    content:"";
    position:absolute;
    top:8px;
    height:2px;
    background:#e5e7eb;
  }
  .orgLane.L::before{ right:0; width:50%; }
  .orgLane.R::before{ left:0; width:50%; }

  .orgLaneBody{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:14px;
  }

  .orgLegend{
    margin-top:12px;
    font-size:12px;
    color:#6b7280;
    display:flex;
    flex-wrap:wrap;
    gap:8px;
  }
  .orgLegend b{ color:#111827; }

  .diagramEmpty{
    color:#6b7280;
    font-size:13px;
  }
</style>
</head>

<body>

<h2>실적 계산기</h2>

<div class="headRow">
  <div>사용자 ID 입력 :</div>
  <input type="number" id="userId">
  <button onclick="createRows()">생성</button>

  <div class="spacer"></div>

  <button class="resetBtn" id="resetScoresBtn" onclick="resetScores()" style="display:none;">
    점수 초기화
  </button>
</div>

<table>
  <colgroup>
    <col class="bc">
    <col class="score">
    <col class="score">
    <col class="carry">
    <col class="carry">
    <col class="sum">
    <col class="sum">
    <col class="ack">
    <col class="bonus">
  </colgroup>

<thead>
<tr>
  <th>비즈니스센터</th>
  <th>왼쪽 점수</th>
  <th>오른쪽 점수</th>
  <th>좌측 실적이월</th>
  <th>우측 실적이월</th>
  <th>왼쪽 합계</th>
  <th>오른쪽 합계</th>
  <th>인정실적</th>
  <th>예상 발생수당</th>
</tr>
</thead>

<tbody id="tableBody"></tbody>

<tfoot>
<tr class="totalRow">
  <td>
    <button id="addCenterBtn" onclick="addCenter()" style="display:none;">
      ＋ 추가 BC
    </button>
  </td>
  <td class="totalLabel" colspan="6">총합계</td>
  <td><span id="totalAck">0</span></td>
  <td><span id="totalBonus">0.0</span></td>
</tr>

<tr class="totalRow">
  <td></td>
  <td class="totalLabel" colspan="6">원화 환산 금액</td>
  <td></td>
  <td><span id="totalBonusKrw">0</span></td>
</tr>
</tfoot>
</table>

<div class="diagramWrap">
  <div class="diagramTitle">도식</div>
  <div id="diagram" class="diagramUI">
    <div class="diagramEmpty">사용자 ID를 입력 후 생성하면 도식이 표시됩니다.</div>
  </div>
</div>

<script>
/* ===== 상태 ===== */
let mergeTarget = {};
let lastExtraPos = null;
let centerCount = 3;
let highlightBySource = {};

/* ===== DOM 헬퍼 ===== */
const $ = (id) => document.getElementById(id);

/* ===== 입력 UX ===== */
function clearZeroOnFocus(el){ if(el.value === "0") el.value = ""; }
function restoreZeroOnBlur(el){ if(el.value === "") el.value = "0"; }

/* ===== 숫자 유틸 ===== */
function parseNum(v){
  const s = String(v ?? "0").replace(/,/g, "").trim();
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}
function fmtInt(n){ return parseNum(n).toLocaleString("en-US"); }
function fmt1(n){
  return parseNum(n).toLocaleString("en-US", {minimumFractionDigits:1, maximumFractionDigits:1});
}
function getVal(id){
  const el = $(id);
  if(!el) return 0;
  if(el.value !== undefined) return parseNum(el.value);
  return parseNum(el.innerText);
}
function setText(id, t){
  const el = $(id);
  if(el) el.innerText = t;
}
function displayWithLimit(el, v){
  if(!el) return;
  el.innerText = fmtInt(v);
  if(v === 5000) el.classList.add("blue");
  else el.classList.remove("blue");
}

/* ✅ 입력 상한(0~5000) 강제 */
function clamp5000(el){
  if(!el) return;
  let v = parseNum(el.value);
  if(v > 5000) v = 5000;
  if(v < 0) v = 0;
  el.value = String(v);
}

/* ===== 추가센터 입력 활성/비활성 ===== */
function toggleInputsByPos(pos, enabled){
  ["l","r","cl","cr"].forEach(prefix=>{
    const el = $(`${prefix}${pos}`);
    if(el) el.disabled = !enabled;
  });
}

/* ===== 점수 셀 템플릿(일반) ===== */
function scoreCellHTML(pos, side){
  const dispId = side === "l" ? `displ${pos}` : `dispr${pos}`;
  const inputId = side === "l" ? `l${pos}` : `r${pos}`;
  const subId  = side === "l" ? `addl${pos}` : `addr${pos}`;

  return `
    <div class="scoreCell">
      <span class="mainScore" id="${dispId}">0</span>
      <input type="number" value="0" min="0" max="5000"
        onfocus="clearZeroOnFocus(this)" onblur="restoreZeroOnBlur(this)"
        oninput="clamp5000(this); calc()" id="${inputId}">
      <div class="mini">하위 점수: <span id="${subId}">0</span></div>
    </div>
  `;
}

/* ===== 점수 셀 템플릿(001 전용) ===== */
function scoreCell001HTML(side){
  const dispId = side === "l" ? "l001" : "r001";
  const inputId = side === "l" ? "l001_in" : "r001_in";
  const subId  = side === "l" ? "addl001" : "addr001";

  return `
    <div class="scoreCell">
      <span class="mainScore" id="${dispId}">0</span>
      <input type="number" value="0" min="0" max="5000"
        onfocus="clearZeroOnFocus(this)" onblur="restoreZeroOnBlur(this)"
        oninput="clamp5000(this); calc()" id="${inputId}">
      <div class="mini">하위 점수: <span id="${subId}">0</span></div>
    </div>
  `;
}

/* ===== 위치 옵션 ===== */
function buildTargetOptions(currentPos){
  const curNum = Number(currentPos);
  let html = `<option value="">선택</option>`;
  for(let n=2; n<=curNum-1; n++){
    const p = String(n).padStart(3,"0");
    html += `<option value="l${p}">${p} 왼쪽</option>`;
    html += `<option value="r${p}">${p} 오른쪽</option>`;
  }
  return html;
}

/* ===== 하이라이트 ===== */
function cellIdFromTarget(t){
  if(!t) return null;
  const side = t[0];
  const pos = t.slice(1);
  return side === "l" ? `tdl${pos}` : `tdr${pos}`;
}
function clearHighlightForSource(srcPos){
  const prevT = highlightBySource[srcPos];
  if(!prevT) return;
  const cid = cellIdFromTarget(prevT);
  const el = cid ? $(cid) : null;
  if(el) el.classList.remove("hl");
  delete highlightBySource[srcPos];
}
function setHighlightForSource(srcPos, newT){
  clearHighlightForSource(srcPos);
  if(!newT) return;
  const cid = cellIdFromTarget(newT);
  const el = cid ? $(cid) : null;
  if(el) el.classList.add("hl");
  highlightBySource[srcPos] = newT;
}

/* ===== 생성(001~003) ===== */
function createRows(){
  const id = parseNum($("userId").value);
  if(!id) return;

  $("tableBody").innerHTML = "";
  centerCount = 3;
  mergeTarget = {};
  lastExtraPos = null;
  highlightBySource = {};

  ["001","002","003"].forEach(pos=>{
    const tr = document.createElement("tr");
    tr.id = `row${pos}`;

    if(pos === "001"){
      tr.innerHTML = `
        <td><span class="bcId" title="${id}.${pos}">${id}.${pos}</span></td>
        <td id="tdl001">${scoreCell001HTML("l")}</td>
        <td id="tdr001">${scoreCell001HTML("r")}</td>
        <td><input type="number" value="0" min="0" max="5000"
              onfocus="clearZeroOnFocus(this)" onblur="restoreZeroOnBlur(this)"
              oninput="clamp5000(this); calc()" id="cl001"></td>
        <td><input type="number" value="0" min="0" max="5000"
              onfocus="clearZeroOnFocus(this)" onblur="restoreZeroOnBlur(this)"
              oninput="clamp5000(this); calc()" id="cr001"></td>
        <td><span id="sumL001">0</span></td>
        <td><span id="sumR001">0</span></td>
        <td><span id="ack001">0</span></td>
        <td><span id="bonus001">0.0</span></td>
      `;
    } else {
      tr.innerHTML = `
        <td><span class="bcId" title="${id}.${pos}">${id}.${pos}</span></td>
        <td id="tdl${pos}">${scoreCellHTML(pos,"l")}</td>
        <td id="tdr${pos}">${scoreCellHTML(pos,"r")}</td>
        <td><input type="number" value="0" min="0" max="5000"
              onfocus="clearZeroOnFocus(this)" onblur="restoreZeroOnBlur(this)"
              oninput="clamp5000(this); calc()" id="cl${pos}"></td>
        <td><input type="number" value="0" min="0" max="5000"
              onfocus="clearZeroOnFocus(this)" onblur="restoreZeroOnBlur(this)"
              oninput="clamp5000(this); calc()" id="cr${pos}"></td>
        <td><span id="sumL${pos}">0</span></td>
        <td><span id="sumR${pos}">0</span></td>
        <td><span id="ack${pos}">0</span></td>
        <td><span id="bonus${pos}">0.0</span></td>
      `;
    }

    $("tableBody").appendChild(tr);
  });

  $("addCenterBtn").style.display = "inline-block";
  $("resetScoresBtn").style.display = "inline-block";

  setText("addl001", "0");
  setText("addr001", "0");

  calc();
}

/* ===== 추가/삭제 ===== */
function addCenter(){
  const id = parseNum($("userId").value);
  if(!id) return;

  centerCount++;
  const pos = String(centerCount).padStart(3,"0");
  mergeTarget[pos] = "";

  const tr = document.createElement("tr");
  tr.id = `row${pos}`;

  tr.innerHTML = `
    <td>
      <div class="bcCell">
        <button class="delBtn" id="delBtn${pos}" onclick="deleteLastCenter()" style="display:none;" title="비즈니스센터 삭제">✕</button>
        <div class="bcText">
          <span class="bcId" title="${id}.${pos}">${id}.${pos}</span>
          <div class="bcMini">위치:
            <select id="target${pos}" onchange="setMerge('${pos}', this.value)">
              ${buildTargetOptions(pos)}
            </select>
          </div>
        </div>
      </div>
    </td>

    <td id="tdl${pos}">${scoreCellHTML(pos,"l")}</td>
    <td id="tdr${pos}">${scoreCellHTML(pos,"r")}</td>

    <td><input type="number" value="0" min="0" max="5000" disabled
      onfocus="clearZeroOnFocus(this)" onblur="restoreZeroOnBlur(this)"
      oninput="clamp5000(this); calc()" id="cl${pos}"></td>

    <td><input type="number" value="0" min="0" max="5000" disabled
      onfocus="clearZeroOnFocus(this)" onblur="restoreZeroOnBlur(this)"
      oninput="clamp5000(this); calc()" id="cr${pos}"></td>

    <td><span id="sumL${pos}">0</span></td>
    <td><span id="sumR${pos}">0</span></td>
    <td><span id="ack${pos}">0</span></td>
    <td><span id="bonus${pos}">0.0</span></td>
  `;

  $("tableBody").appendChild(tr);

  toggleInputsByPos(pos, false);
  $("l"+pos).disabled = true;
  $("r"+pos).disabled = true;

  if(lastExtraPos){
    const prevBtn = $(`delBtn${lastExtraPos}`);
    if(prevBtn) prevBtn.style.display = "none";
  }
  const curBtn = $(`delBtn${pos}`);
  if(curBtn) curBtn.style.display = "inline-block";
  lastExtraPos = pos;

  calc();
}

function deleteLastCenter(){
  if(centerCount < 4) return;

  const pos = String(centerCount).padStart(3,"0");
  clearHighlightForSource(pos);

  const row = $(`row${pos}`);
  if(row) row.remove();

  delete mergeTarget[pos];
  centerCount--;

  if(centerCount >= 4){
    lastExtraPos = String(centerCount).padStart(3,"0");
    const btn = $(`delBtn${lastExtraPos}`);
    if(btn) btn.style.display = "inline-block";
  } else {
    lastExtraPos = null;
  }

  calc();
}

function setMerge(pos, v){
  mergeTarget[pos] = v;

  const enabled = !!v;
  toggleInputsByPos(pos, enabled);
  $("l"+pos).disabled = !enabled;
  $("r"+pos).disabled = !enabled;

  setHighlightForSource(pos, v);
  calc();
}

/* ✅ 점수 초기화(센터/위치 유지, 점수/이월만 0) */
function resetScores(){
  for(let n=1; n<=centerCount; n++){
    const p = String(n).padStart(3,"0");
    const cl = $(`cl${p}`); if(cl) cl.value = "0";
    const cr = $(`cr${p}`); if(cr) cr.value = "0";
  }
  for(let n=2; n<=centerCount; n++){
    const p = String(n).padStart(3,"0");
    const l = $(`l${p}`); if(l) l.value = "0";
    const r = $(`r${p}`); if(r) r.value = "0";
  }
  const l001 = $("l001_in"); if(l001) l001.value = "0";
  const r001 = $("r001_in"); if(r001) r001.value = "0";

  calc();
}

/* =========================
   ✅ 도식(조직도) 아래 숫자 정렬(합계 배지는 건드리지 않음)
   ========================= */
function alignDiagramNumbers(){
  const nodes = document.querySelectorAll("#diagram .orgNode");
  if(!nodes.length) return;

  nodes.forEach(node=>{
    const badgeL = node.querySelector(".nodeTotals .scoreBadge.L");
    const badgeR = node.querySelector(".nodeTotals .scoreBadge.R");
    const kL = badgeL?.querySelector(".k");
    const kR = badgeR?.querySelector(".k");

    const mainL = node.querySelector(".nodeLine.main > :nth-child(1)");
    const mainR = node.querySelector(".nodeLine.main > :nth-child(2)");
    const carryL = node.querySelector(".carryVal");
    const carryR = node.querySelector(".nodeLine.carry > :nth-child(2)");

    if(!badgeL || !badgeR || !kL || !kR || !mainL || !mainR || !carryL || !carryR) return;

    const numRight = (badge, kSpan) => {
      const r = document.createRange();
      r.setStartAfter(kSpan);
      r.setEndAfter(badge.lastChild);
      const rect = r.getBoundingClientRect();
      return rect.width ? rect.right : badge.getBoundingClientRect().right;
    };

    const badgeNumRightL = numRight(badgeL, kL);
    const badgeNumRightR = numRight(badgeR, kR);

    const mainRightL = mainL.getBoundingClientRect().right;
    const mainRightR = mainR.getBoundingClientRect().right;

    node.style.setProperty("--shiftL", `${badgeNumRightL - mainRightL}px`);
    node.style.setProperty("--shiftR", `${badgeNumRightR - mainRightR}px`);
  });
}

/* =========================
   ✅ 도식(조직도) + 3줄 점수 표시
   ========================= */
function getUserId(){
  const v = parseNum($("userId").value);
  return v ? String(v) : "사용자ID";
}

function buildChildrenMap(){
  const children = {};
  for(let n=4; n<=centerCount; n++){
    const src = String(n).padStart(3,"0");
    const t = mergeTarget[src];
    if(!t) continue;
    const side = (t[0] === "l") ? "L" : "R";
    const parent = t.slice(1);
    if(!children[parent]) children[parent] = [];
    children[parent].push({pos: src, side});
  }
  Object.keys(children).forEach(k=>{
    children[k].sort((a,b)=>Number(a.pos)-Number(b.pos));
  });
  return children;
}

function buildOrgTree(rootPos, childrenMap){
  function dfs(pos){
    const node = { pos, side: null, children: [] };
    const kids = childrenMap[pos] || [];
    node.children = kids.map(k => {
      const child = dfs(k.pos);
      child.side = k.side;
      return child;
    });
    return node;
  }
  return dfs(rootPos);
}

function getNodeMetrics(pos){
  const totalL = getVal(`sumL${pos}`);
  const totalR = getVal(`sumR${pos}`);

  const scoreL = (pos === "001") ? getVal("l001") : getVal(`displ${pos}`);
  const scoreR = (pos === "001") ? getVal("r001") : getVal(`dispr${pos}`);

  const carryL = getVal(`cl${pos}`);
  const carryR = getVal(`cr${pos}`);

  return { totalL, totalR, scoreL, scoreR, carryL, carryR };
}

function makeOrgNode(title, meta, pillLR, pos){
  const m = getNodeMetrics(pos);

  const capL = (m.totalL >= 5000) ? "cap" : "";
  const capR = (m.totalR >= 5000) ? "cap" : "";

  const node = document.createElement("div");
  node.className = "orgNode";
  node.innerHTML = `
    <div class="id">${title}</div>
    <div class="meta">${meta}</div>

    <div class="nodeTotals">
      <div class="scoreBadge L ${capL}"><span class="k">L</span>${fmtInt(m.totalL)}</div>
      <div class="scoreBadge R ${capR}"><span class="k">R</span>${fmtInt(m.totalR)}</div>
    </div>

    <div class="nodeLine main">
      <span class="val">${fmtInt(m.scoreL)}</span>
      <span class="val">${fmtInt(m.scoreR)}</span>
    </div>

    <div class="nodeLine carry">
      <div class="carryCell">
        <div class="carryLabel">이월</div>
        <span class="carryVal">${fmtInt(m.carryL)}</span>
      </div>
      <span class="val">${fmtInt(m.carryR)}</span>
    </div>

    ${pillLR ? `<div class="sidePill ${pillLR}">${pillLR}</div>` : ``}
  `;
  return node;
}

function renderOrgChart(treeNode, userId, isRoot){
  const container = document.createElement("div");
  container.className = "orgTree" + ((treeNode.children?.length) ? " hasChildren" : "");

  const label = `[${userId}.${treeNode.pos}]`;
  const meta = isRoot ? "루트 센터" : "추가 센터";
  const pill = isRoot ? null : treeNode.side;

  container.appendChild(makeOrgNode(label, meta, pill, treeNode.pos));

  const kids = treeNode.children || [];
  if(kids.length){
    const leftKids = kids.filter(k => k.side === "L");
    const rightKids = kids.filter(k => k.side === "R");

    const lanes = document.createElement("div");
    lanes.className = "orgChildrenLR";

    const laneL = document.createElement("div");
    laneL.className = "orgLane L";
    laneL.innerHTML = `
      <div class="orgLaneTitle"><span class="lanePill L">L</span></div>
      <div class="orgLaneBody"></div>
    `;

    const laneR = document.createElement("div");
    laneR.className = "orgLane R";
    laneR.innerHTML = `
      <div class="orgLaneTitle"><span class="lanePill R">R</span></div>
      <div class="orgLaneBody"></div>
    `;

    const laneLBody = laneL.querySelector(".orgLaneBody");
    const laneRBody = laneR.querySelector(".orgLaneBody");

    leftKids.forEach(ch => laneLBody.appendChild(renderOrgChart(ch, userId, false)));
    rightKids.forEach(ch => laneRBody.appendChild(renderOrgChart(ch, userId, false)));

    lanes.appendChild(laneL);
    lanes.appendChild(laneR);
    container.appendChild(lanes);
  }

  return container;
}

function renderDiagram(){
  const id = getUserId();
  const diagramEl = $("diagram");
  if(!diagramEl) return;

  const childrenMap = buildChildrenMap();
  const leftTree  = buildOrgTree("002", childrenMap);
  const rightTree = buildOrgTree("003", childrenMap);

  diagramEl.innerHTML = "";

  const wrap = document.createElement("div");
  wrap.className = "orgWrap";

  const top = document.createElement("div");
  top.className = "orgTop";
  top.appendChild(makeOrgNode(`[${id}.001]`, "최상위 센터", null, "001"));
  wrap.appendChild(top);

  const row = document.createElement("div");
  row.className = "orgRow";

  const leftCol = document.createElement("div");
  leftCol.className = "orgCol";
  leftCol.innerHTML = `
    <div class="orgColTitle">
      <span>왼쪽 트리</span>
      <span class="orgBadge">루트: ${id}.002</span>
    </div>
  `;
  leftCol.appendChild(renderOrgChart(leftTree, id, true));
  row.appendChild(leftCol);

  const rightCol = document.createElement("div");
  rightCol.className = "orgCol";
  rightCol.innerHTML = `
    <div class="orgColTitle">
      <span>오른쪽 트리</span>
      <span class="orgBadge">루트: ${id}.003</span>
    </div>
  `;
  rightCol.appendChild(renderOrgChart(rightTree, id, true));
  row.appendChild(rightCol);

  wrap.appendChild(row);
  diagramEl.appendChild(wrap);

  requestAnimationFrame(() => alignDiagramNumbers());
}

/* ===== 계산(연쇄 합산 포함) ===== */
function calc(){
  const baseL = {}, baseR = {};
  const addL = {}, addR = {};

  for(let n=2; n<=centerCount; n++){
    const p = String(n).padStart(3,"0");
    baseL[p] = getVal(`l${p}`);
    baseR[p] = getVal(`r${p}`);
    addL[p] = 0;
    addR[p] = 0;
  }

  for(let n=centerCount; n>=4; n--){
    const src = String(n).padStart(3,"0");
    const t = mergeTarget[src];
    if(!t) continue;

    const totalSrc = (baseL[src] + baseR[src]) + (addL[src] + addR[src]);

    if(t.startsWith("l")){
      const tp = t.slice(1);
      if(addL[tp] !== undefined) addL[tp] += totalSrc;
    } else if(t.startsWith("r")){
      const tp = t.slice(1);
      if(addR[tp] !== undefined) addR[tp] += totalSrc;
    }
  }

  const disp = {};
  for(let n=2; n<=centerCount; n++){
    const p = String(n).padStart(3,"0");
    const L = baseL[p] + addL[p];
    const R = baseR[p] + addR[p];
    disp[p] = {L, R};

    setText(`addl${p}`, fmtInt(addL[p]));
    setText(`addr${p}`, fmtInt(addR[p]));
    setText(`displ${p}`, fmtInt(L));
    setText(`dispr${p}`, fmtInt(R));
  }

  const inL001 = getVal("l001_in");
  const inR001 = getVal("r001_in");

  const subL001 = ((disp["002"]?.L ?? 0) + (disp["002"]?.R ?? 0));
  const subR001 = ((disp["003"]?.L ?? 0) + (disp["003"]?.R ?? 0));

  const L001 = subL001 + inL001;
  const R001 = subR001 + inR001;

  setText("l001", fmtInt(L001));
  setText("r001", fmtInt(R001));

  setText("addl001", fmtInt(subL001));
  setText("addr001", fmtInt(subR001));

  let totalAck = 0;
  let totalBonus = 0;

  for(let n=1; n<=centerCount; n++){
    const p = String(n).padStart(3,"0");

    let L = 0, R = 0;
    if(p === "001"){
      L = getVal("l001");
      R = getVal("r001");
    } else {
      L = disp[p].L;
      R = disp[p].R;
    }

    const sumL = Math.min(L + getVal(`cl${p}`), 5000);
    const sumR = Math.min(R + getVal(`cr${p}`), 5000);

    displayWithLimit($(`sumL${p}`), sumL);
    displayWithLimit($(`sumR${p}`), sumR);

    const minv = Math.min(sumL, sumR);
    const ack = (minv >= 125) ? minv : 0;

    setText(`ack${p}`, fmtInt(ack));

    const bonus = ack * 0.2;
    setText(`bonus${p}`, ack ? fmt1(bonus) : "0.0");

    totalAck += ack;
    totalBonus += bonus;
  }

  setText("totalAck", fmtInt(totalAck));
  setText("totalBonus", fmt1(totalBonus));

  const krw = Math.round(totalBonus * 1150);
  setText("totalBonusKrw", fmtInt(krw));

  renderDiagram();
}
</script>

</body>
</html>
